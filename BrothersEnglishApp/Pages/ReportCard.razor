@page "/report"
@using BrothersEnglishApp.Models
@using BrothersEnglishApp.Services
@inject LocalStorageService Storage

<PageTitle>成績表</PageTitle>

<div class="container mt-4">
    <h3 class="mb-4">🏆 成績表</h3>

    @if (allWords == null || !allWords.Any())
    {
        <div class="alert alert-info">まずは「一括登録」で単語を登録してね！</div>
    }
    else
    {
        <div class="row">
            @* つかさのカード *@
            <div class="col-md-6 mb-3">
                <div class="card border-primary shadow-sm">
                    <div class="card-header bg-primary text-white">つかさ</div>
                    <div class="card-body text-center">
                        <h5 class="card-title">進捗率</h5>
                        <div class="display-4">@GetProgressPercentage("つかさ")%</div>
                        <p class="text-muted">@GetClearedCount("つかさ") / @allWords.Count 単語</p>
                        <div class="progress">
                            <div class="progress-bar" style="@GetBarStyle("つかさ")"></div>
                        </div>
                    </div>
                </div>
            </div>

            @* まもるのカード *@
            <div class="col-md-6 mb-3">
                <div class="card border-success shadow-sm">
                    <div class="card-header bg-success text-white">まもる</div>
                    <div class="card-body text-center">
                        <h5 class="card-title">進捗率</h5>
                        <div class="display-4">@GetProgressPercentage("まもる")%</div>
                        <p class="text-muted">@GetClearedCount("まもる") / @allWords.Count 単語</p>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="@GetBarStyle("まもる")"></div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h4 class="mt-5 mb-3">📝 単語ごとの記録</h4>

        <div class="row">
            @foreach (var name in new[] { "つかさ", "まもる", "管理人"})
            {
                <div class="col-md-6">
                    <h5>@(name)くんの履歴</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover border">
                            <thead class="table-light">
                                <tr>
                                    <th>単語</th>
                                    <th class="text-success">○</th>
                                    <th class="text-danger">×</th>
                                    <th>最終学習日</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (userProgresses.ContainsKey(name))
                                {
                                    @foreach (var status in userProgresses[name].WordStatuses.OrderByDescending(s => s.LastReviewed))
                                    {
                                        var word = allWords?.FirstOrDefault(w => w.Id == status.WordId);
                                        if (word != null)
                                        {
                                            <tr>
                                                <td>@word.Word</td>
                                                <td class="text-success">@status.CorrectCount</td>
                                                <td class="text-danger">@status.IncorrectCount</td>
                                                <td style="font-size: 0.8rem;">@status.LastReviewed.ToString("MM/dd HH:mm")</td>
                                            </tr>
                                        }
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<EnglishWord>? allWords;
    private Dictionary<string, UserProgress> userProgresses = new();
    // style属性に渡す文字列を安全に作る関数
    private string GetBarStyle(string name)
    {
        return $"width: {GetProgressPercentage(name)}%;";
    }

    protected override async Task OnInitializedAsync()
    {
        allWords = await Storage.LoadAsync<List<EnglishWord>>("MasterWords");

        // 二人分のデータをロード
        var names = new[] { "つかさ", "まもる" };
        foreach (var name in names)
        {
            var p = await Storage.LoadAsync<UserProgress>($"User_{name}");
            if (p != null) userProgresses[name] = p;
        }
    }

    private int GetClearedCount(string name)
    {
        if (!userProgresses.ContainsKey(name)) return 0;
        // Statusが1以上の単語をカウント
        return userProgresses[name].WordStatuses.Count(s => s.Status >= 1);
    }

    private int GetProgressPercentage(string name)
    {
        if (allWords == null || !allWords.Any()) return 0;
        return (int)((double)GetClearedCount(name) / allWords.Count * 100);
    }
}