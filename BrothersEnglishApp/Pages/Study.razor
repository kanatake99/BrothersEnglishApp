@page "/study"
@inject WordRepository WordRepo
@inject TrainingEngine Engine
@inject UserContext Context
@inject LocalStorageService Storage
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject TrainingEngine Engine // トレーニングエンジンの注入

<PageTitle>今日の復習</PageTitle>

<div class="container mt-4">
    @if (_isFinished)
    {
        <div class="text-center">
            <h2>おつかれさま！</h2>
            <p>今日の 学習は 終わりだよ。</p>
            <div class="display-1 text-success mb-4"><i class="bi bi-trophy-fill"></i></div>
            <button class="btn btn-primary btn-lg" @onclick="GoReport">成績表を 見る</button>
        </div>
    }
    else if (_currentQuestion != null)
    {
        <div class="card shadow-sm mx-auto" style="max-width: 500px;">
            <div class="card-header bg-info text-white text-center">
                がくしゅう中 (@(_doneCount + 1) / @_studyGoal)
            </div>
            <div class="card-body text-center p-5">
                <p class="text-muted">@(_currentQuestion.IsEnglishToJapanese ? "これの意味は？" : "これは英語で？")</p>
                <h1 class="display-4 mb-4">@_currentQuestion.QuestionText</h1>
                
                <div class="d-grid gap-3">
                    @foreach (var option in _currentQuestion.Options)
                    {
                        <button class="btn btn-outline-primary btn-lg py-3 fs-4" @onclick="() => HandleAnswer(option)">
                            @option
                        </button>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="text-center">
            <p>きょう おぼえた単語を よみこみ中...</p>
        </div>
    }
</div>

@code {
    private List<EnglishWord> _allWords = [];
    private UserProgress? _userProgress;
    private Question? _currentQuestion;
    private int _studyGoal = 10;
    private int _doneCount = 0;
    private bool _isFinished = false;

    
    protected override async Task OnInitializedAsync()
    {
        _allWords = await WordRepo.GetWordsAsync();
        _userProgress = await Storage.LoadAsync<UserProgress>($"User_{Context.CurrentUserId}");
        var settings = await Storage.LoadAsync<AppSettings>("AppSettings");
        _studyGoal = settings?.DailyGoal ?? 10;

        GenerateNextQuestion();
    }


    private void GenerateNextQuestion()
    {
        if (_doneCount >= _studyGoal)
        {
            FinishStudy();
            return;
        }

        // ★ロジックをEngineに丸投げ！
        _currentQuestion = Engine.GenerateStudyQuestion(_allWords, _userProgress);
    }

    private async void FinishStudy()
    {
        _isFinished = true;
        var todayKey = DateTime.UtcNow.ToString("yyyyMMdd");
        if (_userProgress != null)
        {
            if (!_userProgress.ActivityLog.ContainsKey(todayKey))
                _userProgress.ActivityLog[todayKey] = new DayActivity();

            _userProgress.ActivityLog[todayKey].StudyDone = true;
            await Storage.SaveAsync($"User_{Context.CurrentUserId}", _userProgress);
        }
        StateHasChanged();
    }

    private async Task HandleAnswer(string selected)
    {
        if (selected == _currentQuestion?.CorrectAnswer)
        {
            _doneCount++;
            GenerateNextQuestion();
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "ざんねん！もういっかい！");
        }
    }

    private void GoReport() => Navigation.NavigateTo("report");
}

<style>
    /* ボタンの中の文字を、データの通りのケース（大文字小文字）で表示する */
    .btn {
        text-transform: none !important;
    }

    /* ついでに問題文のデカい文字も勝手に変わらないようにガードしておく */
    .display-4 {
        text-transform: none !important;
    }
</style>